import{b as E,n as q,d as M,c as b,e as g,a as P,f as A,g as T}from"./doichain-store.By_VzKP0.js";var _={exports:{}},d=typeof Reflect=="object"?Reflect:null,y=d&&typeof d.apply=="function"?d.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)},p;d&&typeof d.ownKeys=="function"?p=d.ownKeys:Object.getOwnPropertySymbols?p=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:p=function(e){return Object.getOwnPropertyNames(e)};function B(n){console&&console.warn&&console.warn(n)}var k=Number.isNaN||function(e){return e!==e};function c(){c.init.call(this)}_.exports=c;_.exports.once=F;c.EventEmitter=c;c.prototype._events=void 0;c.prototype._eventsCount=0;c.prototype._maxListeners=void 0;var w=10;function v(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(c,"defaultMaxListeners",{enumerable:!0,get:function(){return w},set:function(n){if(typeof n!="number"||n<0||k(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");w=n}});c.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};c.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||k(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function O(n){return n._maxListeners===void 0?c.defaultMaxListeners:n._maxListeners}c.prototype.getMaxListeners=function(){return O(this)};c.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var s=e==="error",o=this._events;if(o!==void 0)s=s&&o.error===void 0;else if(!s)return!1;if(s){var i;if(t.length>0&&(i=t[0]),i instanceof Error)throw i;var u=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw u.context=i,u}var a=o[e];if(a===void 0)return!1;if(typeof a=="function")y(a,this,t);else for(var f=a.length,h=j(a,f),r=0;r<f;++r)y(h[r],this,t);return!0};function C(n,e,t,r){var s,o,i;if(v(t),o=n._events,o===void 0?(o=n._events=Object.create(null),n._eventsCount=0):(o.newListener!==void 0&&(n.emit("newListener",e,t.listener?t.listener:t),o=n._events),i=o[e]),i===void 0)i=o[e]=t,++n._eventsCount;else if(typeof i=="function"?i=o[e]=r?[t,i]:[i,t]:r?i.unshift(t):i.push(t),s=O(n),s>0&&i.length>s&&!i.warned){i.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=n,u.type=e,u.count=i.length,B(u)}return n}c.prototype.addListener=function(e,t){return C(this,e,t,!1)};c.prototype.on=c.prototype.addListener;c.prototype.prependListener=function(e,t){return C(this,e,t,!0)};function K(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function S(n,e,t){var r={fired:!1,wrapFn:void 0,target:n,type:e,listener:t},s=K.bind(r);return s.listener=t,r.wrapFn=s,s}c.prototype.once=function(e,t){return v(t),this.on(e,S(this,e,t)),this};c.prototype.prependOnceListener=function(e,t){return v(t),this.prependListener(e,S(this,e,t)),this};c.prototype.removeListener=function(e,t){var r,s,o,i,u;if(v(t),s=this._events,s===void 0)return this;if(r=s[e],r===void 0)return this;if(r===t||r.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,r.listener||t));else if(typeof r!="function"){for(o=-1,i=r.length-1;i>=0;i--)if(r[i]===t||r[i].listener===t){u=r[i].listener,o=i;break}if(o<0)return this;o===0?r.shift():I(r,o),r.length===1&&(s[e]=r[0]),s.removeListener!==void 0&&this.emit("removeListener",e,u||t)}return this};c.prototype.off=c.prototype.removeListener;c.prototype.removeAllListeners=function(e){var t,r,s;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[e]),this;if(arguments.length===0){var o=Object.keys(r),i;for(s=0;s<o.length;++s)i=o[s],i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=r[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function x(n,e,t){var r=n._events;if(r===void 0)return[];var s=r[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?$(s):j(s,s.length)}c.prototype.listeners=function(e){return x(this,e,!0)};c.prototype.rawListeners=function(e){return x(this,e,!1)};c.listenerCount=function(n,e){return typeof n.listenerCount=="function"?n.listenerCount(e):R.call(n,e)};c.prototype.listenerCount=R;function R(n){var e=this._events;if(e!==void 0){var t=e[n];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}c.prototype.eventNames=function(){return this._eventsCount>0?p(this._events):[]};function j(n,e){for(var t=new Array(e),r=0;r<e;++r)t[r]=n[r];return t}function I(n,e){for(;e+1<n.length;e++)n[e]=n[e+1];n.pop()}function $(n){for(var e=new Array(n.length),t=0;t<e.length;++t)e[t]=n[t].listener||n[t];return e}function F(n,e){return new Promise(function(t,r){function s(i){n.removeListener(e,o),r(i)}function o(){typeof n.removeListener=="function"&&n.removeListener("error",s),t([].slice.call(arguments))}N(n,e,o,{once:!0}),e!=="error"&&W(n,s,{once:!0})})}function W(n,e,t){typeof n.on=="function"&&N(n,"error",e,t)}function N(n,e,t,r){if(typeof n.on=="function")r.once?n.once(e,t):n.on(e,t);else if(typeof n.addEventListener=="function")n.addEventListener(e,function s(o){r.once&&n.removeEventListener(e,s),t(o)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}var H=_.exports;const m=(n,e,t)=>JSON.stringify({jsonrpc:"2.0",method:n,params:e,id:t}),J=(n,e)=>(t,r)=>{t?e(t):n(r)},U=(n,e,t)=>(r,s)=>{if(s&&s[0]&&s[0].id)for(let o of s)o.param=t[o.id];r?e(r):n(s)};class V{constructor(e,t,r,s){this.id=0,this.port=t,this.host=e,this.callback_message_queue={},this.subscribe=new H.EventEmitter,this._protocol=r,this._options=s}getStatus(){return this.status}connect(){return this.status===1?Promise.resolve():(this.status=1,this.connectSocket(this.port,this.host,this._protocol))}connectSocket(e,t,r){return new Promise((s,o)=>{let i=new WebSocket(`${r}://${t}:${e}/`);this.ws=i,i.onopen=()=>{console.log("connected websocket main component"),s()},i.onmessage=a=>{this.onMessage(a.data)},i.onclose=a=>{console.log("Socket is closed: "+JSON.stringify(a)),this.status=0,this.onClose()};const u=a=>o(a);i.onerror=a=>{console.error("Socket encountered error: ",a.message,"Closing socket"),this.status=0,i.close(),u()}})}close(){this.status!==0&&(this.ws&&(this.ws.close(),this.ws=null),this.status=0)}request(e,t){return this.status===0?Promise.reject(new Error("ESOCKET")):new Promise((r,s)=>{const o=++this.id,i=m(e,t,o);this.callback_message_queue[o]=J(r,s),this.ws.send(i+`
`,"utf8")})}requestBatch(e,t,r){return this.status===0?Promise.reject(new Error("ESOCKET")):new Promise((s,o)=>{let i={},u=[];for(let f of t){const h=++this.id;r!==void 0?u.push(m(e,[f,r],h)):u.push(m(e,[f],h)),i[h]=f}const a="["+u.join(",")+"]";this.callback_message_queue[this.id]=U(s,o,i),this.ws.send(a+`
`,"utf8")})}response(e){let t;if(!e.id&&e[0]&&e[0].id)for(let r of e)r.id&&this.callback_message_queue[r.id]&&(t=this.callback_message_queue[r.id],delete this.callback_message_queue[r.id]);else t=this.callback_message_queue[e.id];t?(delete this.callback_message_queue[e.id],e.error?t(e.error):t(null,e.result||e)):console.log("Can't get callback")}onMessage(e){const t=JSON.parse(e);t instanceof Array?this.response(t):t.id!==0?this.response(t):this.subscribe.emit(t.method,t.params)}onClose(e){this.status=0,Object.keys(this.callback_message_queue).forEach(t=>{this.callback_message_queue[t](new Error("close connect")),delete this.callback_message_queue[t]})}}let l;E.subscribe(n=>l=n);q.subscribe(n=>n);const L=25,Y=5e3,X=async n=>{if(!n)return;let e=0,t;for(;e<L;){const a=M.filter(f=>f.network===n.name);t=a[Math.floor(Math.random()*a.length)],l=new V(t.host,t.port,t.protocol);try{E.set(l),await l.connect("electrum-client-js","1.4.2");break}catch(f){if(console.error("Connection failed, retrying...",f),e++,e<L)g.set(`retrying (${e})`),b.set(`retrying (${e} - ${t.host})`),await new Promise(h=>setTimeout(h,Y));else throw new Error("Max retries reached. Unable to connect to Electrum server.")}}const r=await l.request("server.version");g.set(r),console.log("electrumServerVersion",r);const s=t.protocol+"://"+t.host+":"+t.port;b.set(s),console.log("network",s);const o=await l.request("server.banner");console.log("electrumServerBanner",o),P.set(o);const i=await l.request("blockchain.headers.subscribe");A.set(i);const u=await l.request("blockchain.relayfee");return T.set(u),s};function z(n){return!n||n==="offline"||n.includes("retry")?{isConnected:!1,serverName:n||"No server connected"}:{isConnected:!0,serverName:n}}export{X as connectElectrum,z as getConnectionStatus};
